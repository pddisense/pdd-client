#!/bin/bash
# PDD is a platform for privacy-preserving Web searches collection.
# Copyright (C) 2016-2018 Vincent Primault <v.primault@ucl.ac.uk>
#
# PDD is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# PDD is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with PDD.  If not, see <http://www.gnu.org/licenses/>.

set -e

dist_dir=dist
rm -rf ${dist_dir} && mkdir -p ${dist_dir}

function print_help_and_exit {
cat <<EOF
Usage: $0 [-help] [-publish]

  -help      Print this help message and exit
  -publish   Publish (default: false, which does not publish anything)
EOF
exit 0
}

publish=0
for opt in "$@"
do
  case "$opt" in
    -publish)
      publish=1
      ;;
    -help)
      print_help_and_exit
      ;;
    *)
      echo "Unknown option $opt"
      print_help_and_exit
      ;;
  esac
done

yarn build
zip -rj dist/chrome.zip dist/chrome

if [[ ${publish} == 1 ]]; then
  # This is somewhat experimental...
  # API docs: https://developer.chrome.com/webstore/using_webstore_api
  echo "Publishing Chrome extension... (EXPERIMENTAL)"
  URL="https://accounts.google.com/o/oauth2/auth?response_type=code&scope=https://www.googleapis.com/auth/chromewebstore&client_id=775596672401-r80j39mm322k4t4oek67n8bb63vrvn38.apps.googleusercontent.com&redirect_uri=urn:ietf:wg:oauth:2.0:oob"
  if which xdg-open > /dev/null; then
    xdg-open $URL
  elif which open > /dev/null; then
    open $URL
  else
    echo "Please navigate to $URL"
  fi
  read -p "Please paste here the authorisation code" TOKEN
  curl \
    -H "Authorization: Bearer $TOKEN"  \
    -H "x-goog-api-version: 2" \
    -X PUT \
    -T dist/chrome.zip \
    -v \
    https://www.googleapis.com/upload/chromewebstore/v1.1/items/ipeekohlgfhagcopnndkgoommcihmdmk
  curl \
    -H "Authorization: Bearer $TOKEN"  \
    -H "x-goog-api-version: 2" \
    -H "Content-Length: 0" \
    -X POST \
    -v \
    https://www.googleapis.com/chromewebstore/v1.1/items/ipeekohlgfhagcopnndkgoommcihmdmk/publish
  echo "The extension should be soon available at https://chrome.google.com/webstore/detail/private-data-donor/ipeekohlgfhagcopnndkgoommcihmdmk"
fi
